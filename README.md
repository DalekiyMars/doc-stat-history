# Сервис управления документами (Document Status History)
### Версия сервиса: 0.0.2

Backend-сервис для работы с документами, их статусами (DRAFT → SUBMITTED → APPROVED), историей изменений и реестром утверждений.  
Включает фоновые воркеры для пакетной обработки и отдельную утилиту для массового создания документов.

## Стек технологий

- Java 21 + Spring Boot 3
- PostgreSQL (в Docker)
- JPA / Hibernate (с batch-оптимизациями)
- Liquibase (миграции)
- Gradle
- Testcontainers (для интеграционных тестов)

## Требования к окружению

- Java 21+
- Docker (для запуска PostgreSQL)
- Gradle 7+ (опционально, можно использовать ./gradlew)

## Запуск сервиса

### 1. Запустите PostgreSQL через Docker Compose

В корне проекта выполните:

```bash
docker-compose up -d
```

БД будет доступна на порту 13000:

- База: document-util
- Пользователь: admin
- Пароль: secret

### 2. Сборка и запуск приложения
```bash
./gradlew bootRun
```

Или соберите jar и запустите:
```bash
./gradlew build
java -jar build/libs/doc-stat-history-0.0.2.jar
```
Сервис стартует на порту 8080 (по умолчанию).
### 3. Конфигурация

Основные параметры находятся в src/main/resources/application.yaml:
```yaml
app:
   document:
      number-prefix: DOC        # префикс уникального номера документа
   worker:
      batch-size: 50            # размер пачки для воркеров
      submit-delay-ms: 30000    # интервал запуска SUBMIT-worker (мс)
      approve-delay-ms: 30000   # интервал запуска APPROVE-worker (мс)
```
## Утилита массового создания документов

Отдельная консольная утилита (doc-stat-util) создаёт заданное количество документов через API сервиса.

Создайте файл ```config.txt``` (пример в ```doc-stat-util/src/config.txt```):
```yaml
service.url=http://localhost:8080
generator.count=100
generator.batchSize=50
generator.initiator=util-generator
generator.author=util
generator.docNamePrefix=Generated Document
```

- ```service.url``` — базовый URL сервиса (без /api)
- ```generator.count``` — общее количество документов
- ```generator.batchSize``` — размер одной пачки (максимум 1000, отправляется на /api/v1/documents/batch)
- остальные параметры задают значения полей документов

## Запуск

Перейдите в директорию doc-stat-util и выполните:
```bash
javac Main.java
java Main config.txt
```
Утилита выведет прогресс по каждой пачке и общую статистику:

```txt
=== Запуск пакетной генерации документов ===
Задано к созданию: 100 документов
...
Пачка 1 (50 док.): успешно 50, ошибок 0, время 245 мс
Прогресс: 50/100 документов обработано.
...
=== Генерация завершена ===
Всего пачек: 2
Общее время: 512 мс
Успешно: 100, ошибок: 0
```
Для мониторинга количества документов в разных статусах можно выполнить SQL-запрос:
```sql 
SELECT status, COUNT(*) FROM entity_tables.documents GROUP BY status;
```

API (основные эндпоинты)

   | Метод |                  Эндпоинт                  |                                                          Описание |
   |:------|:------------------------------------------:|------------------------------------------------------------------:|
   | POST  |             	/api/v1/documents             |                                    	Создать один документ (DRAFT) |
   | POST  |          	/api/v1/documents/batch          |                               	Создать пачку документов (до 1000) |
   | GET   |          	/api/v1/documents/{id}           |       	Получить документ по ID (с историей при ?withHistory=true) |
   | GET   |     	/api/v1/documents/batch?ids=1,2,3     |                   	Получить документы по списку ID (с пагинацией) |
   | POST  |         	/api/v1/documents/submit          |          	Отправить документы на согласование (DRAFT → SUBMITTED) |
   | POST  |         	/api/v1/documents/approve         |                       	Утвердить документы (SUBMITTED → APPROVED) |
   | GET   |         	/api/v1/documents/search          |      	Поиск с фильтрами (status, author, from, to, limit, cursor) |
   | POST  | 	/api/v1/documents/{id}/concurrent-approve | 	Тест конкурентного утверждения (с параметрами threads, attempts) |

## Тестирование

Интеграционные тесты используют Testcontainers, поэтому требуется работающий Docker.

Запуск всех тестов:
```bash 
./gradlew test
```

Основные тестовые сценарии покрывают:
- создание (одиночное и пакетное)
- получение документов с историей
- переходы по статусам (включая конфликты)
- откат утверждения при ошибке записи в реестр
- частичные успехи в пакетных операциях
- конкурентное утверждение (ровно одна успешная попытка)

## Опциональные улучшения
### Обработка запросов с 5000+ ID

Для пакетных операций с очень большим количеством идентификаторов можно:

- Разбивать входной список на подзапросы фиксированного размера (например, по 1000) и обрабатывать их параллельно.
- Перейти на асинхронную обработку с возвратом 202 Accepted и последующим уведомлением через WebSocket или polling.

### Вынос реестра утверждений в отдельную систему

Если реестр должен быть отдельным микросервисом или БД:

- Заменить прямое сохранение в ApprovalRegistryRepository на вызов внешнего HTTP-сервиса.
- Обеспечение согласованности: при успешном утверждении вызывать внешний сервис; при ошибке — откат статуса документа.
- Альтернативно — использовать событийный подход: после утверждения публиковать событие, которое асинхронно обрабатывается потребителем (с повторными попытками при сбоях).

### Примечания

    Подробный анализ планов выполнения запросов и используемых индексов приведён в файле EXPLAIN.md.
